/* query 2013-07-11 */
(function(t){"use strict";function n(t){return"function"==typeof t}function r(t){return t!==void 0}function i(t){return"string"==typeof t}function e(t){return null===t}function u(t,n){var i;for(i in n)A.call(n,i)&&!r(t[i])&&(t[i]=n[i]);return t}function s(t,n){var r;if(t===n)return!0;if(typeof t!=typeof n)return!1;if(t==n)return!0;if(!t&&n||t&&!n)return!1;if("object"==typeof t){for(r in t)if(!s(t[r],n[r]))return!1;return!0}return!1}function f(t,n){var i=u({},t);return r(n)&&!e(n)&&u(i,n),i}function o(t){return function(n){return n[t]}}function h(t){var n=[];return t.replace(M,function(t,r,i){n.push({field:r,alias:i||r})}),function(t){var r={};return n.forEach(function(n){r[n.alias]=t[n.field]}),r}}function c(t){var n=Object.keys(t),r=n.length;return function(i,e){for(var u=-1;r>++u;)if(i[n[u]]!==e[t[n[u]]])return!1;return!0}}function a(t){var n=Object.keys(t),r=n.length;return function(i){for(var e=r;e--;)if(i[n[e]]!==t[n[e]])return!1;return!0}}function l(t,n){return t>n?1:n>t?-1:0}function p(t,n){return t.localeCompare(n)}function m(t,n){var r=[];return t.replace(j,function(t,e,u){r.push({field:e,direction:u?O.test(u)?1:-1:1,comparer:i(n[e])?p:l})}),v(r)}function v(t){var n=t.length;return function(r,i){for(var e,u,s,f,o=-1;n>++o;)if(e=t[o],u=r[e.field],s=i[e.field],f=e.comparer(u,s))return f*e.direction;return 0}}function g(t,n,r){var e,u=[],s=[],f=t[0],o=n[0];for(e in r)A.call(r,e)&&(u.push({field:e,direction:1,comparer:i(f[e])?p:l}),s.push({field:r[e],direction:1,comparer:i(o[e])?p:l}));t.sort(v(u)),n.sort(v(s))}function w(t,n,r,i,e,u){var s,f=[],o=[];if(t.forEach(function(t){s=!1,n.forEach(function(n,e){r(t,n)&&(s=!0,f.push(i(t,n)),u&&(o[e]=!0))}),e&&!s&&f.push(i(t,null))}),u)for(var h=-1,c=n.length;c>++h;)o[h]||f.push(i(null,n[h]));return f}function y(t,n,r,i){var e,u,s=c(r),f=[],o=0,h=0,a=t.length,l=n.length;for(g(t,n,r);a>o&&l>h;)e=t[o],u=n[h],s(e,u)?(f.push(i(e,u)),h++):h>o?o++:h++;return f}function d(t,i,e,u){var s,f=[];return t.forEach(function(t,o){s=i(t,o),r(s)?n(s.forEach)?s.forEach(function(n){f.push(e(t,n))}):f.push(e(t,s)):u&&f.push(e(t))}),f}var E,k,b=Array.prototype.slice,A=Object.prototype.hasOwnProperty;E=k=function(t){var n=this;return n.items=t&&t.length&&b.call(t,0)||[],n.items.forEach(function(t,r){n[r]=t}),n.length=n.items.length,n},k.version="0.9.0",k.from=function(t){return new k(t)},k.prototype=k.fn={length:0,elementAt:function(t,n){return t>=this.length||0>t?n:this[t]},first:function(t,i){if(i=r(i)?i:null,t){for(var e,u=-1,s=this.length,f=n(t)?t:a(t);s>++u;)if(e=this[u],f(e,u,this))return e;return i}return this.length?this[0]:i},last:function(t,i){if(i=r(i)?i:null,t){for(var e,u=this.length,s=n(t)?t:a(t);u--;)if(e=this[u],s(e,u,this))return e;return i}return this.length?this[this.length-1]:i},single:function(t,i){var e,u=this.length,s=[];if(t)for(var f=n(t)?t:a(t);u--&&(e=this[u],f(e,u,this)&&s.push(e),2!==s.length););else s=this;if(!s.length&&r(i))return i;if(1!==s.length)throw Error("Only one result should be found when calling 'single'.");return s[0]},clone:function(){return new k(this.toArray())},defaultIfEmpty:function(t){return this.length?this:new k([t])},forEach:function(t,n){for(var r=-1,i=this.length;i>++r;)t.call(n,this[r],r,this);return this},sequenceEquals:function(t,n){var r=this.length,i=n||s;if(t.length!==this.length)return!1;for(;r--;)if(!i(this[r],t[r]))return!1;return!0},toArray:function(){return b.call(this,0)},toDictionary:function(t,r){var e,u={},s=n(r);return t=i(t)?o(t):t,this.forEach(function(n,i){if(e=t(n,i),e in u)throw error("Duplicate keys were attempted to be inserted.");u[e]=s?r(n,i):n}),u},toLookup:function(t,r){var e,u={},s=n(r);return t=i(t)?o(t):t,this.forEach(function(n,i){e=t(n,i),u[e]=u[e]||[],u[e].push(s?r(n,i):n)}),u}};var M=/\b(\w+)\b(?:\s+(?:as\s+)?(\w+))?\s*(?:,|$)/gi;k.fn.where=function(t){if(t){var r=n(t)?t:a(t);return new k(this.items.filter(r,this))}return this},k.fn.all=function(t){return this.items.every(n(t)?t:a(t),this)},k.fn.any=function(t){return t&&this.length?this.items.some(n(t)?t:a(t),this):!!this.length},k.fn.contains=function(t,n){var r=n||s;return this.any(function(n){return r(n,t)})},k.fn.select=function(t){var n=i(t)?h(t):t;return new k(this.items.map(n,this))},k.fn.selectMany=function(t,n){return new k(d(this.items,t,n||f,!1))},k.fn.avg=function(t){return this.sum(t)/this.length},k.fn.count=function(t){return this.where(t).length},k.fn.max=function(t){return Math.max.apply(Math,n(t)?this.items.map(t,this):this.items)},k.fn.min=function(t){return Math.min.apply(Math,n(t)?this.items.map(t,this):this.items)},k.fn.sum=function(t){var r=0,i=n(t);return this.forEach(function(n,e){r+=i?t(n,e):n}),r},k.Group=function(t,n){this.key=t,this.items=n||[]},k.fn.groupBy=function(t,n){var r,i,e=[];i=this.toLookup(t,n);for(r in i)A.call(i,r)&&e.push(new k.Group(r,i[r]));return new k(e)};var j=/\b(\w+)\b\s*(asc|desc)?\s*(?:,|$)/gi,O=/^a/i;k.fn.orderBy=function(t){if(2>this.items.length)return this.clone();var n;return n=i(t)?m(t,this.items[0]):t,new k(this.items.sort(n))},k.fn.reverse=function(){return new k(this.items.reverse())},k.fn.shuffle=function(){if(1>=this.length)return this.clone();for(var t,n,r=this.length,i=this.toArray(),e=[];r--;)t=Math.floor(Math.random()*(r+1)),n=i[t],i[t]=i[r],e[r]=n;return new k(e)},k.fn.crossApply=function(t,n){return new k(d(this.items,t,n||f,!1))},k.fn.crossJoin=function(t,n){var r=[],i=n||f;return this.forEach(function(n){t.forEach(function(t){r.push(i(n,t))})}),new k(r)},k.fn.fullJoin=function(t,n,r){return new k(w(this.items,t.items||t,n,r||f,!0,!0))},k.fn.join=function(t,r,i){return new k((n(r)?w:y)(this.items,t.items||t,r,i||f,!1))},k.fn.outerApply=function(t,n){return new k(d(this.items,t,n||f,!0))},k.fn.outerJoin=function(t,n,r){return new k(w(this.items,t.items||t,n,r||f,!0))},k.fn.skip=function(t){return new k(b.call(this.items,t))},k.fn.skipWhile=function(t){for(var r=-1,i=this.items.length,e=n(t)?t:a(t);i>++r&&e(this.items[r],r,this););return this.skip(r)},k.fn.take=function(t){return new k(b.call(this.items,0,t))},k.fn.takeWhile=function(t){for(var r=-1,i=this.items.length,e=n(t)?t:a(t);i>++r&&e(this.items[r],r,this););return this.take(r)},k.fn.concat=function(t){return new k(this.toArray().concat(t.items||t))},k.fn.distinct=function(t){var n,r=this,i=r.items.length,e=[],u=t||s;return r.forEach(function(t,s){for(n=i;--n>s&&!u(t,r.items[n]););s===n&&e.push(t)}),new k(e)},k.fn.except=function(t,n){var r=[],i=n||s;return t=t instanceof E?t:new k(t),this.forEach(function(n){t.contains(n,i)||r.push(n)}),new k(r).distinct(i)},k.fn.intersect=function(t,n){var r=[],i=n||s;return t=t instanceof E?t:new k(t),this.forEach(function(n){t.contains(n,i)&&r.push(n)}),new k(r).distinct(i)},k.fn.union=function(t,n){return new k(this.items.concat(t.items||t)).distinct(n)},k.fn.zip=function(t,n){var r=-1,i=Math.min(this.items.length,t.length),e=[];for(n=n||f,t=t.items||t;i>++r;)e.push(n(this.items[r],t[r]));return new k(e)},t.Query=k})(this);